---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { site } from "../../lib/site";
import { getCollection, render, type CollectionEntry } from "astro:content";
import { getRelatedPosts } from "../../lib/related-posts";

import BlogPostSchema from "../../components/BlogPostSchema.astro";

import ClinicalNote from "../../components/mdx/ClinicalNote.astro";
import Evidence from "../../components/mdx/Evidence.astro";
import CTA from "../../components/mdx/CTA.astro";

export async function getStaticPaths() {
  const posts = await getCollection("blog");
  return posts
    .filter((p: CollectionEntry<"blog">) => !p.data.draft)
    .map((post) => ({
      params: { slug: post.slug },
      props: { post },
    }));
}

const { post } = Astro.props;

const { Content } = await render(post);

const pub = new Date(post.data.pubDate).toLocaleDateString("en-US", {
  year: "numeric",
  month: "long",
  day: "numeric",
  timeZone: "UTC",
});

const allPosts = await getCollection("blog");
const related = getRelatedPosts(allPosts, post, 3);

const base = import.meta.env.BASE_URL;

const postUrl = `${site.seo.siteUrl}${base}blog/${post.slug}`;
// console.log(postUrl);
const encodedUrl = encodeURIComponent(postUrl);
const encodedTitle = encodeURIComponent(post.data.title);

// console.log(`${site.seo.siteUrl}${post.data.heroImage}`);

const share = {
  facebook: `https://www.facebook.com/sharer/sharer.php?u=${encodedUrl}`,
  x: `https://twitter.com/intent/tweet?url=${encodedUrl}&text=${encodedTitle}`,
  linkedin: `https://www.linkedin.com/sharing/share-offsite/?url=${encodedUrl}`,
};
---

<BaseLayout 
  title={`${post.data.title}`} 
  description={post.data.description}
  image={post.data.heroImage ? `${site.seo.siteUrl}${post.data.heroImage}` : undefined}
  article={true}
  keywords={post.data.tags?.join(", ") || post.data.category}
>
  <BlogPostSchema post={post} url={postUrl} />

  <article class="mx-auto max-w-3xl px-4 py-12">
    <header class="border-b border-slate-200 pb-6">
      <p class="text-xs uppercase tracking-wide text-brand-700">
        {post.data.category ?? "Blog"}
      </p>
      <h1 class="mt-2 text-3xl font-bold tracking-tight text-slate-900">
        {post.data.title}
      </h1>
      <p class="mt-3 text-sm leading-6 text-slate-600">
        {post.data.description}
      </p>

      <!-- <div class="mt-3 text-xs text-slate-500">
        {post.data.author} <span class="text-slate-400" aria-hidden="true">•</span> <time datetime={new Date(post.data.pubDate).toISOString()}>{pub}</time>
      </div> -->
      <div class="mt-4 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
        {/* Author + date */}
        <div class="text-xs text-slate-500">
          {post.data.author}
          <span class="mx-1 text-slate-400" aria-hidden="true">•</span>
          <time datetime={new Date(post.data.pubDate).toISOString()}>{pub}</time>
        </div>

        {/* Share buttons */}
        <div class="flex items-center gap-3">
          <span class="text-xs text-slate-500">Share</span>

          <a
            href={share.facebook}
            target="_blank"
            rel="noopener noreferrer"
            aria-label="Share on Facebook"
            class="rounded-full border border-slate-200 bg-white p-2 text-slate-600 hover:text-brand-700 hover:border-brand-200 focus-visible:ring-2 focus-visible:ring-brand-600"
          >
            {/* Facebook */}
            <svg viewBox="0 0 24 24" class="h-4 w-4" fill="currentColor">
              <path d="M22.675 0h-21.35C.597 0 0 .597 0 1.326v21.348C0 23.403.597 24 1.326 24h11.495v-9.294H9.692V11.01h3.129V8.309c0-3.1 1.893-4.788 4.659-4.788 1.325 0 2.463.099 2.795.143v3.24h-1.918c-1.504 0-1.796.715-1.796 1.763v2.313h3.587l-.467 3.696h-3.12V24h6.116C23.403 24 24 23.403 24 22.674V1.326C24 .597 23.403 0 22.675 0z"/>
            </svg>
          </a>

          <a
            href={share.x}
            target="_blank"
            rel="noopener noreferrer"
            aria-label="Share on X"
            class="rounded-full border border-slate-200 bg-white p-2 text-slate-600 hover:text-brand-700 hover:border-brand-200 focus-visible:ring-2 focus-visible:ring-brand-600"
          >
            {/* X */}
            <svg viewBox="0 0 24 24" class="h-4 w-4" fill="currentColor">
              <path d="M18.244 2H21.6l-7.344 8.39L23 22h-6.828l-5.344-6.68L4.68 22H1.32l7.856-8.98L1 2h7l4.828 6.06L18.244 2z"/>
            </svg>
          </a>

          <a
            href={share.linkedin}
            target="_blank"
            rel="noopener noreferrer"
            aria-label="Share on LinkedIn"
            class="rounded-full border border-slate-200 bg-white p-2 text-slate-600 hover:text-brand-700 hover:border-brand-200 focus-visible:ring-2 focus-visible:ring-brand-600"
          >
            {/* LinkedIn */}
            <svg viewBox="0 0 24 24" class="h-4 w-4" fill="currentColor">
              <path d="M22.23 0H1.77C.79 0 0 .774 0 1.727v20.545C0 23.227.79 24 1.77 24h20.46c.98 0 1.77-.773 1.77-1.728V1.727C24 .774 23.21 0 22.23 0zM7.09 20.452H3.56V9h3.53v11.452zM5.325 7.433c-1.13 0-2.047-.924-2.047-2.06 0-1.137.917-2.06 2.047-2.06s2.047.923 2.047 2.06c0 1.136-.917 2.06-2.047 2.06zM20.452 20.452h-3.53v-5.569c0-1.328-.026-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.94v5.666h-3.53V9h3.389v1.561h.047c.472-.9 1.624-1.852 3.341-1.852 3.571 0 4.23 2.351 4.23 5.406v6.337z"/>
            </svg>
          </a>
        </div>
      </div>
    </header>

    {/* Post content */}
    <div class="prose prose-slate mt-8 max-w-none prose-headings:scroll-mt-24 prose-a:text-brand-700">
      <Content components={{ ClinicalNote, Evidence, CTA }} />
      
    </div>
    
    {/* Related posts */}
    {related.length > 0 && (
      <section class="mt-12 border-t border-slate-200 pt-8">
        <h2 class="text-base font-semibold text-slate-900">Related posts</h2>
        <div class="mt-4 grid gap-4 sm:grid-cols-3">
          {related.map((p) => (
            <a
              href={`${base}blog/${p.slug}`}
              class="rounded-2xl border border-slate-200 bg-white p-4 no-underline shadow-soft hover:shadow-md transition"
            >
              <p class="text-xs uppercase tracking-wide text-brand-700">{p.data.category ?? "Blog"}</p>
              <p class="mt-2 text-sm font-semibold text-slate-900">{p.data.title}</p>
              <p class="mt-2 text-xs text-slate-600 line-clamp-3">{p.data.description}</p>
            </a>
          ))}
        </div>
      </section>
    )}
  </article>
</BaseLayout>
