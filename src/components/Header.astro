---
import { site } from "../lib/site";
import { Image } from "astro:assets";
import logo from "../assets/okonkwocare-logo.png";

const base = import.meta.env.BASE_URL;

const nav = [
    { href: `${base}`, label: "Home" },
    {
        href: `${base}services`,
        label: "Services",
        overviewLabel: "Services Overview",
        children: [
        // { href: `${base}services`, label: "Services Overview" },
        { href: `${base}services/adhd`, label: "Holistic ADHD Program" },
        { href: `${base}services/membership`, label: "Concierge Membership" },
        // Optional future pages:
        // { href: `${base}services/membership`, label: "Concierge Membership" },
        // { href: `${base}services/nutrition`, label: "Nutrition & Wellness" },
        ],
    },
    { 
        href: `${base}resources/patient-resources`, 
        label: "Resources",
        overviewLabel: "Patient Resources",
        children: [
        { href: `${base}resources/patient-resources`, label: "Patient Resources" },
        { href: `${base}resources/faq`, label: "FAQs" },
        ],
    },
    { href: `${base}blog`, label: "Blog" },
    { href: `${base}about-dr-okonkwo`, label: "About" },
    { href: `${base}press`, label: "Media" },
    // { href: `${base}faq`, label: "FAQs" }
//   { href: `${base}contact`, label: "Contact" }
];

// Active link logic (exact match, with home special-cased)
const path = Astro.url?.pathname ?? "/";

const normalize = (p: string) =>
  p.endsWith("/") && p !== "/" ? p.slice(0, -1) : p;

const normalizedPath = normalize(path);

const isActiveExact = (href: string) => normalize(href) === normalizedPath;

// Marks parent as active for any nested route (e.g., /services/adhd)
const isActiveSection = (href: string) => {
  const h = normalize(href);
  return h !== "/" && (normalizedPath === h || normalizedPath.startsWith(h + "/"));
};

const slugify = (s: string) =>
  s.toLowerCase().replace(/[^a-z0-9]+/g, "-").replace(/(^-|-$)/g, "");
---

<header class="sticky top-0 z-40 border-b border-slate-200 bg-white/90 backdrop-blur">
    <div class="mx-auto flex max-w-7xl items-center justify-between px-4 py-5">
        <!-- Brand -->
        <a href={`${base}`} class="flex items-center gap-3 no-underline">
            <!-- <div
                class="grid h-10 w-10 place-items-center rounded-xl border border-brand-100 bg-brand-50 text-brand-800"
                aria-hidden="true">
                <span class="text-sm font-bold">OC</span>
            </div> -->
            <Image
                src={logo}
                alt="Okonkwo Care Pediatrics logo"
                width={150}
                height={99}
                format="webp"
                class="h-16 w-auto object-contain"
                loading="eager"
                decoding="async"
            />
            <!-- <div class="leading-tight">
                <div class="text-sm font-semibold text-slate-900">{site.name}</div>
                <div class="text-xs text-slate-600">{site.tagline}</div>
            </div> -->
        </a>

        <!-- Desktop nav -->
        <!-- <nav class="hidden items-center gap-6 text-sm lg:flex" aria-label="Primary">
            {nav.map((item) => {
                const active = isActive(item.href);
                return (
                    <a
                        href={item.href}
                        aria-current={active ? "page" : undefined}
                        class:list={[
                            "no-underline rounded-lg px-2 py-1 transition",
                            active ? "text-brand-800 bg-brand-50" : "text-slate-700 hover:text-slate-900 hover:bg-slate-50"
                        ]}>{item.label}
                    </a>
                );
            })}
            <a
                href={`tel:${site.phoneTel}`}
                class="rounded-xl bg-brand-700 px-4 py-2 text-sm font-semibold text-white no-underline hover:bg-brand-100"
            >Contact Us</a>
        </nav> -->

        <nav class="hidden items-center gap-6 text-sm lg:flex" aria-label="Primary">
            {nav.map((item) => {
                const hasChildren = "children" in item && Array.isArray(item.children);
                const active = hasChildren ? isActiveSection(item.href) : isActiveExact(item.href);

                if (!hasChildren) {
                return (
                    <a
                    href={item.href}
                    aria-current={active ? "page" : undefined}
                    class:list={[
                        "no-underline rounded-lg px-2 py-1 transition",
                        active
                        ? "text-brand-800 bg-brand-50"
                        : "text-slate-700 hover:text-slate-900 hover:bg-slate-50",
                    ]}
                    >
                    {item.label}
                    </a>
                );
                }

                // Services dropdown
                return (
                <div class="relative group">
                    <a
                    href={item.href}
                    aria-current={active ? "page" : undefined}
                    class:list={[
                        "inline-flex items-center gap-1 no-underline rounded-lg px-2 py-1 transition",
                        active
                        ? "text-brand-800 bg-brand-50"
                        : "text-slate-700 hover:text-slate-900 hover:bg-slate-50",
                    ]}
                    >
                    {item.label}
                    <svg
                        class="h-4 w-4 text-slate-500 group-hover:text-slate-700"
                        viewBox="0 0 20 20"
                        fill="currentColor"
                        aria-hidden="true"
                    >
                        <path
                        fill-rule="evenodd"
                        d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.24 4.24a.75.75 0 01-1.06 0L5.21 8.29a.75.75 0 01.02-1.08z"
                        clip-rule="evenodd"
                        />
                    </svg>
                    </a>

                    {/* Dropdown panel (hover + focus-within) */}
                    {/* <div class="pointer-events-none absolute left-0 top-full z-50 mt-2 w-64 opacity-0 transition
                                group-hover:pointer-events-auto group-hover:opacity-100
                                group-focus-within:pointer-events-auto group-focus-within:opacity-100">
                    <div class="rounded-2xl border border-slate-200 bg-white p-2 shadow-lg">
                        {hasChildren && item.children && item.children.map((child) => {
                        const childActive = isActiveExact(child.href);
                        return (
                            <a
                            href={child.href}
                            class:list={[
                                "block rounded-xl px-3 py-2 text-sm no-underline transition",
                                childActive
                                ? "bg-brand-50 text-brand-800"
                                : "text-slate-700 hover:bg-slate-50 hover:text-slate-900",
                            ]}
                            >
                            {child.label}
                            </a>
                        );
                        })}
                    </div>
                    </div> */}

                    {/* Dropdown wrapper (no mt gap) */}
                    <div
                        class="absolute left-0 top-full z-50 w-64 pt-2
                            opacity-0 pointer-events-none transition
                            group-hover:opacity-100 group-hover:pointer-events-auto
                            group-focus-within:opacity-100 group-focus-within:pointer-events-auto"
                    >
                        {/* Hover bridge: invisible strip that keeps hover “connected” */}
                        <div class="absolute left-0 right-0 -top-2 h-2"></div>

                        <div class="rounded-2xl border border-slate-200 bg-white p-2 shadow-lg">
                        {item.children && item.children.map((child) => {
                            const childActive = isActiveExact(child.href);
                            return (
                            <a
                                href={child.href}
                                class:list={[
                                "block rounded-xl px-3 py-2 text-sm no-underline transition",
                                childActive
                                    ? "bg-brand-50 text-brand-800"
                                    : "text-slate-700 hover:bg-slate-50 hover:text-slate-900",
                                ]}
                            >
                                {child.label}
                            </a>
                            );
                        })}
                        </div>
                    </div>
                </div>
                );
            })}

            <!-- <a
                href={`tel:${site.phoneTel}`}
                class="rounded-xl bg-brand-700 px-4 py-2 text-sm font-semibold text-white no-underline hover:bg-brand-100"   
            >
                Contact Us
            </a> -->
            <a
                href={`${base}contact`}
                class="rounded-xl bg-brand-700 px-4 py-2 text-sm font-semibold text-white no-underline hover:bg-brand-100"   
            >
                Contact Us
            </a>
        </nav>


        <!-- Mobile actions -->
        <div class="flex items-center gap-2 lg:hidden">
            <a
                href={`${base}contact`}
                class="block w-full rounded-xl border text-center border-slate-200 bg-white px-3 py-2 text-sm font-semibold text-slate-900 no-underline hover:bg-slate-50"
                aria-label="Contact Us"
            >Contact Us</a>

            <!-- Hamburger -->
            <button
                id="menu-button"
                type="button"
                aria-label="Open menu"
                aria-expanded="false"
                aria-controls="mobile-drawer"
                class="rounded-xl border border-slate-200 bg-white p-2 hover:bg-slate-50 focus-visible:ring-2 focus-visible:ring-brand-600"
                >
                <svg class="h-6 w-6 text-slate-800" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" />
                </svg>
            </button>
        </div>
    </div>

    <!-- FULL-SCREEN MOBILE DRAWER -->
    <div
        id="mobile-drawer"
        class="mobile-drawer hidden lg:hidden"
        role="dialog"
        aria-modal="true"
        aria-label="Mobile navigation"
        >
        <!-- Overlay -->
        <button
            id="drawer-overlay"
            type="button"
            class="drawer-overlay"
            aria-label="Close menu"
            tabindex="-1"
        ></button>

        <!-- Panel -->
        <div class="drawer-panel" role="document">
            <div class="flex items-center justify-between border-b border-slate-200 px-4 py-4">
                <a href={`${base}`} data-nav-link class="flex items-center gap-3 no-underline">
                    <Image
                        src={logo}
                        alt="Okonkwo Care Pediatrics logo"
                        width={160}
                        height={99}
                        format="webp"
                        class="h-10 w-auto object-contain"
                        loading="eager"
                        decoding="async"
                    />
                    <!-- <div class="leading-tight">
                        <div class="text-sm font-semibold text-slate-900">{site.name}</div>
                        <div class="text-xs text-slate-600">Pediatrics</div>
                    </div> -->
                </a>
                <button
                    id="drawer-close"
                    type="button"
                    class="rounded-xl border border-slate-200 bg-white p-2 hover:bg-slate-50 focus-visible:ring-2 focus-visible:ring-brand-600"
                    aria-label="Close menu"
                    >
                    <svg class="h-6 w-6 text-slate-800" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

                <!-- <nav class="px-4 py-4 space-y-2 bg-white/90" aria-label="Mobile Primary">
                    {nav.map((item) => {
                        const active = isActive(item.href);
                        return (
                            <a
                                href={item.href}
                                data-nav-link
                                aria-current={active ? "page" : undefined}
                                class:list={[
                                    "block rounded-xl px-4 py-3 text-sm font-medium no-underline transition",
                                    active
                                    ? "bg-brand-50 text-brand-800 border border-brand-100"
                                    : "text-slate-900 hover:bg-slate-50 border border-transparent"
                                ]}
                                >
                                    {item.label}
                            </a>
                        );
                    })}

                    <a
                        href={`tel:${site.phoneTel}`}
                        class="mt-3 block rounded-xl bg-brand-700 px-4 py-3 text-center text-sm font-semibold text-white no-underline hover:bg-brand-800"
                        >
                            Call {site.phoneDisplay}
                    </a>

                    <div class="mt-4 rounded-2xl border border-slate-200 bg-slate-50 p-4 text-xs leading-5 text-slate-600">
                        For emergencies, dial 911. For urgent concerns, call the office.
                    </div>
                </nav> -->

                <nav class="px-4 py-4 space-y-2 bg-white/90" aria-label="Mobile Primary">
                    {nav.map((item) => {
                        const hasChildren = "children" in item && Array.isArray(item.children);
                        const active = hasChildren ? isActiveSection(item.href) : isActiveExact(item.href);

                        // Normal link items
                        if (!hasChildren) {
                        return (
                            <a
                            href={item.href}
                            data-nav-link
                            aria-current={active ? "page" : undefined}
                            class:list={[
                                "block rounded-xl px-4 py-3 text-sm font-medium no-underline transition",
                                active
                                ? "bg-brand-50 text-brand-800 border border-brand-100"
                                : "text-slate-900 hover:bg-slate-50 border border-transparent",
                            ]}
                            >
                            {item.label}
                            </a>
                        );
                        }

                        // Accordion for Services
                        const openByDefault = active; // open if you're on /services/*
                        const key = slugify(item.label);
                        return (
                        <div class="rounded-xl border border-slate-200 bg-white">
                            <button
                            data-accordion-trigger={key}
                            type="button"
                            class:list={[
                                "w-full flex items-center justify-between rounded-xl px-4 py-3 text-sm font-medium transition",
                                active ? "text-brand-800 bg-brand-50" : "text-slate-900 hover:bg-slate-50",
                            ]}
                            aria-expanded={openByDefault ? "true" : "false"}
                            data-accordion-trigger="services"
                            >
                            <span class="flex items-center gap-2">
                                {item.label}
                            </span>
                            <svg
                                data-accordion-trigger={key}
                                class:list={[
                                "h-4 w-4 transition-transform",
                                openByDefault ? "rotate-180" : "rotate-0",
                                ]}
                                viewBox="0 0 20 20"
                                fill="currentColor"
                                aria-hidden="true"
                                data-accordion-chevron="services"
                            >
                                <path
                                fill-rule="evenodd"
                                d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.24 4.24a.75.75 0 01-1.06 0L5.21 8.29a.75.75 0 01.02-1.08z"
                                clip-rule="evenodd"
                                />
                            </svg>
                            </button>

                            <div
                            data-accordion-panel={key}
                            class:list={[
                                "px-2 pb-2 py-1 space-y-1",
                                openByDefault ? "block" : "hidden",
                            ]}
                            >
                            {/* Parent overview link (optional but useful) */}
                            {item.overviewLabel && (
                            <a
                                href={item.href}
                                data-nav-link
                                class:list={[
                                "block rounded-xl px-3 py-2 text-xs font-semibold uppercase tracking-wide text-slate-500",
                                isActiveExact(item.href)
                                    ? "bg-brand-50 text-brand-800"
                                    : "text-slate-700 hover:bg-slate-50 hover:text-slate-900",
                                ]}
                            >
                                {item.overviewLabel}
                            </a>
                            )}

                            {hasChildren && item.children && item.children
                                .filter((c) => c.href !== item.href)
                                .map((child) => {
                                const childActive = isActiveExact(child.href);
                                return (
                                    <a
                                    href={child.href}
                                    data-nav-link
                                    class:list={[
                                        "block rounded-xl px-3 py-2 text-sm no-underline transition",
                                        childActive
                                        ? "bg-brand-50 text-brand-800"
                                        : "text-slate-700 hover:bg-slate-50 hover:text-slate-900",
                                    ]}
                                    >
                                    {child.label}
                                    </a>
                                );
                                })}
                            </div>
                        </div>
                        );
                    })}

                    <a
                        href={`tel:${site.phoneTel}`}
                        class="mt-3 block rounded-xl bg-brand-700 px-4 py-3 text-center text-sm font-semibold text-white no-underline hover:bg-brand-800"
                    >
                        Call {site.phoneDisplay}
                    </a>

                    <div class="mt-4 rounded-2xl border border-slate-200 bg-slate-50 p-4 text-xs leading-5 text-slate-600">
                        For emergencies, dial 911. For urgent concerns, call the office.
                    </div>
                </nav>

            </div>
        </div>

        <!-- CSS-only animation hooks -->
        <style>
            /* Drawer container (full-screen) */
            .mobile-drawer {
                position: fixed;
                inset: 0;
                z-index: 60;
            }

            /* Overlay fade */
            .drawer-overlay {
                position: absolute;
                inset: 0;
                background: rgba(15, 23, 42, 0.35); /* slate-900 w/ opacity */
                opacity: 0;
                transition: opacity 180ms ease;
            }

            /* Panel slide (right side) */
            .drawer-panel {
                position: absolute;
                top: 0;
                right: 0;
                height: 100%;
                width: min(92vw, 420px);
                background: white;
                border-left: 1px solid rgba(226, 232, 240, 1); /* slate-200 */
                transform: translateX(100%);
                transition: transform 220ms ease;
                box-shadow: 0 20px 60px rgba(2, 6, 23, 0.18);
                display: flex;
                flex-direction: column;
            }

            /* Open state */
            .mobile-drawer[data-open="true"] .drawer-overlay {
                opacity: 1;
            }
            .mobile-drawer[data-open="true"] .drawer-panel {
            transform: translateX(0);
            }

            /* Reduced motion */
            @media (prefers-reduced-motion: reduce) {
                .drawer-overlay,
                .drawer-panel {
                    transition: none !important;
                }
            }
        </style>

        <!-- Behavior: toggle + close-on-route + focus trap + iOS-safe scroll lock -->
        <script>
            import { initMobileMenu } from "../lib/mobile-menu";
            
            // Initialize on DOM ready
            if (document.readyState === "loading") {
                document.addEventListener("DOMContentLoaded", initMobileMenu);
            } else {
                initMobileMenu();
            }

            // Simple accordion for mobile submenu
            // const trigger = document.querySelector('[data-accordion-trigger="services"]');
            // const panel = document.querySelector('[data-accordion-panel="services"]');
            // const chevron = document.querySelector('[data-accordion-chevron="services"]');

            // if (trigger && panel) {
            //     trigger.addEventListener("click", () => {
            //     const isOpen = panel.classList.contains("block");
            //     panel.classList.toggle("hidden", isOpen);
            //     panel.classList.toggle("block", !isOpen);
            //     trigger.setAttribute("aria-expanded", (!isOpen).toString());
            //     if (chevron) chevron.classList.toggle("rotate-180", !isOpen);
            //     });
            // }

            function initAccordionsSingleOpen() {
                document.addEventListener("click", (e) => {
                const target = e.target;
                if (!(target instanceof Element)) return;

                const btn = target.closest("[data-accordion-trigger]");
                if (!btn) return;

                const key = btn.getAttribute("data-accordion-trigger");
                if (!key) return;

                const panel = document.querySelector(`[data-accordion-panel="${key}"]`);
                const chevron = document.querySelector(`[data-accordion-chevron="${key}"]`);
                if (!panel) return;

                const isOpen = panel.classList.contains("block");

                // Close all other accordions
                document.querySelectorAll("[data-accordion-panel]").forEach((p) => {
                    if (!(p instanceof HTMLElement)) return;
                    const pKey = p.getAttribute("data-accordion-panel");
                    if (!pKey || pKey === key) return;

                    p.classList.add("hidden");
                    p.classList.remove("block");

                    const otherBtn = document.querySelector(`[data-accordion-trigger="${pKey}"]`);
                    const otherChevron = document.querySelector(`[data-accordion-chevron="${pKey}"]`);
                    otherBtn?.setAttribute("aria-expanded", "false");
                    otherChevron?.classList.remove("rotate-180");
                });

                // Toggle the clicked one (after closing others)
                panel.classList.toggle("hidden", isOpen);
                panel.classList.toggle("block", !isOpen);
                btn.setAttribute("aria-expanded", (!isOpen).toString());
                if (chevron) chevron.classList.toggle("rotate-180", !isOpen);
                });
            }

            if (document.readyState === "loading") {
                document.addEventListener("DOMContentLoaded", initAccordionsSingleOpen);
            } else {
                initAccordionsSingleOpen();
            }
        </script>
    </div>
</header>
